<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studo - Auth Debug</title>
    <style>
        body {
            background: #0f0f0f;
            color: white;
            font-family: 'IBM Plex Mono', monospace;
            padding: 20px;
            line-height: 1.6;
        }
        .debug-section {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: rgba(76, 175, 80, 0.2); border: 1px solid #4CAF50; }
        .error { background: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; }
        .warning { background: rgba(255, 152, 0, 0.2); border: 1px solid #ff9800; }
        .info { background: rgba(33, 150, 243, 0.2); border: 1px solid #2196F3; }
        button {
            background: #666;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #777; }
        pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîê Studo Authentication Debug</h1>
    
    <div class="debug-section">
        <h2>Current Environment</h2>
        <div id="environmentInfo"></div>
    </div>
    
    <div class="debug-section">
        <h2>LocalStorage Status</h2>
        <div id="localStorageInfo"></div>
        <button onclick="clearLocalStorage()">Clear LocalStorage</button>
        <button onclick="checkLocalStorage()">Refresh Check</button>
    </div>
    
    <div class="debug-section">
        <h2>Supabase Service Status</h2>
        <div id="supabaseInfo"></div>
        <button onclick="testSupabase()">Test Supabase</button>
    </div>
    
    <div class="debug-section">
        <h2>Authentication Flow Test</h2>
        <div id="authFlowInfo"></div>
        <button onclick="testAuthFlow()">Test Auth Flow</button>
        <button onclick="simulateLogin()">Simulate Login</button>
        <button onclick="goToLogin()">Go to Login</button>
        <button onclick="goToMain()">Go to Main App</button>
    </div>
    
    <div class="debug-section">
        <h2>Console Logs</h2>
        <div id="consoleLogs"></div>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script>
        let logs = [];
        
        // Override console.log to capture logs
        const originalLog = console.log;
        console.log = function(...args) {
            logs.push(new Date().toLocaleTimeString() + ': ' + args.join(' '));
            originalLog.apply(console, args);
            updateConsoleLogs();
        };
        
        function updateConsoleLogs() {
            const logsDiv = document.getElementById('consoleLogs');
            logsDiv.innerHTML = '<pre>' + logs.slice(-20).join('\n') + '</pre>';
        }
        
        function addStatus(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            container.appendChild(statusDiv);
        }
        
        function clearStatus(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }
        
        function checkEnvironment() {
            clearStatus('environmentInfo');
            
            const info = {
                'Current URL': window.location.href,
                'Hostname': window.location.hostname,
                'Protocol': window.location.protocol,
                'Is Localhost': window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1',
                'User Agent': navigator.userAgent.substring(0, 50) + '...',
                'Online': navigator.onLine
            };
            
            for (const [key, value] of Object.entries(info)) {
                addStatus('environmentInfo', `${key}: ${value}`, 'info');
            }
        }
        
        function checkLocalStorage() {
            clearStatus('localStorageInfo');
            
            const authKeys = ['isLoggedIn', 'userEmail', 'userId', 'accountDeleted'];
            const hasAuthData = authKeys.some(key => localStorage.getItem(key));
            
            if (hasAuthData) {
                addStatus('localStorageInfo', 'Authentication data found in localStorage', 'success');
                authKeys.forEach(key => {
                    const value = localStorage.getItem(key);
                    if (value) {
                        addStatus('localStorageInfo', `${key}: ${value}`, 'info');
                    }
                });
            } else {
                addStatus('localStorageInfo', 'No authentication data in localStorage', 'warning');
            }
        }
        
        function testSupabase() {
            clearStatus('supabaseInfo');
            
            if (typeof supabase === 'undefined') {
                addStatus('supabaseInfo', 'Supabase library not loaded', 'error');
                return;
            }
            
            addStatus('supabaseInfo', 'Supabase library loaded', 'success');
            
            if (window.SupabaseService) {
                addStatus('supabaseInfo', 'SupabaseService available', 'success');
                
                if (window.SupabaseService.supabase) {
                    addStatus('supabaseInfo', 'Supabase client initialized', 'success');
                } else {
                    addStatus('supabaseInfo', 'Supabase client not initialized', 'warning');
                }
            } else {
                addStatus('supabaseInfo', 'SupabaseService not available', 'error');
            }
        }
        
        async function testAuthFlow() {
            clearStatus('authFlowInfo');
            
            try {
                // Simulate the authentication check from index.html
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                const userEmail = localStorage.getItem('userEmail');
                const userId = localStorage.getItem('userId');
                
                if (!isLoggedIn || !userEmail || !userId) {
                    addStatus('authFlowInfo', 'No valid authentication data found', 'error');
                    return;
                }
                
                addStatus('authFlowInfo', 'Local authentication data valid', 'success');
                
                if (window.SupabaseService) {
                    addStatus('authFlowInfo', 'Testing Supabase session...', 'info');
                    
                    try {
                        const session = await window.SupabaseService.getCurrentSession();
                        const user = await window.SupabaseService.getCurrentUser();
                        
                        if (session && user) {
                            addStatus('authFlowInfo', 'Valid Supabase session found', 'success');
                        } else {
                            addStatus('authFlowInfo', 'No valid Supabase session, would use localStorage fallback', 'warning');
                        }
                    } catch (error) {
                        addStatus('authFlowInfo', `Supabase error: ${error.message}`, 'warning');
                        addStatus('authFlowInfo', 'Would use localStorage fallback', 'info');
                    }
                } else {
                    addStatus('authFlowInfo', 'SupabaseService not available, would use localStorage fallback', 'warning');
                }
                
            } catch (error) {
                addStatus('authFlowInfo', `Auth flow error: ${error.message}`, 'error');
            }
        }
        
        function clearLocalStorage() {
            localStorage.clear();
            sessionStorage.clear();
            addStatus('localStorageInfo', 'LocalStorage cleared', 'info');
            checkLocalStorage();
        }
        
        function goToLogin() {
            window.location.href = './login.html';
        }
        
        function goToMain() {
            window.location.href = './index.html';
        }
        
        function simulateLogin() {
            // Simulate a successful login by setting localStorage data
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('userEmail', 'test@example.com');
            localStorage.setItem('userId', 'test-user-id-12345');
            localStorage.setItem('loginTimestamp', Date.now().toString());
            
            addStatus('authFlowInfo', 'Simulated login data set', 'success');
            checkLocalStorage();
        }
        
        function clearLogs() {
            logs = [];
            updateConsoleLogs();
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkEnvironment();
            checkLocalStorage();
            testSupabase();
            console.log('Debug page loaded');
        });
    </script>
</body>
</html>
